# PINSCHER SALES


## Установка

- запустить докер контейнеры
  - скопировать докерный .env.example в .env и поправить его
- зайти в php контейнер, запустить
  - скопировать проектный .env.example в .env и поправить его
  - composer install
  - php artisan key:generate
  - php artisan migrate
  - php artisan passport:install

## Конфигурация

###  Google Spreadsheets API

- Создать проект в [Google Cloud Platform](https://console.cloud.google.com/projectcreate)
- Активировать [Google Sheets API](https://console.cloud.google.com/apis/library/sheets.googleapis.com)
- Активировать [Google Drive API](https://console.cloud.google.com/apis/library/drive.googleapis.com)
- Создать [учетные данные](https://console.cloud.google.com/apis/credentials) Create service account
- Создать ключи доступа в разделе Service account details -> Keys -> Add Key -> JSON
- Скачать учетные данные и сохранить их как `service-credentials.json` в корневой директории проекта
- Обеспечить доступ на чтение и запись к таблице Google используя `client_email` из файла `service-credentials.json`.
- Определить в `.env` файле `GOOGLE_SPREADSHEET`(название Google таблицы) и `GOOGLE_APPLICATION_NAME` (например. "Pinscher Google Calls")

### Telegram настройки
- `TELEGRAM_BOT_NAME=`"Название телеграм-бота"
- `TELEGRAM_BOT_TOKEN=`"Токен телеграм-бота"
- `TELEGRAM_WEBHOOK_URL=`"вебхук на случай для получения обновлений из бота"

### Настройки SMSRU
- `SMSRU_API_ID=`"api_id из своего [аккаунта](https://sms.ru/?panel=api)"
- `SMSRU_API_SENDER=`"Номер телефона отправителя. Формат: 79002222222"

### Включать/Отключать двухфакторную авторизацию
- `TWO_FACTOR_AUTHENTICATION_MODE_ENABLED=false` По умолчанию стоит `false`.

## Алгоритм отправки отчетов для гугл-проектов
- ежеминутно выбираются проекты:
  - активные(is_active)
  - с непустыми днями недели(sending_period)
  - если сегодня праздник, то с галкой sending_include_holidays
- по отобранным проектам запускается команда отправки, если:
  - текущая минута соответствует настройкам проекта (report_time)
  - текущий день недели соответствует настройкам проекта(sending_period)
- выполняется команда
  - проверка существования проекта
  - проверка наличия телеграм чата + его активности
  - автоопределение временного периода отчета:
    - если предыдущего отчета не было или отправка ручная(ручная отправка отменена)
      - если перед текущим днем недели есть рабочие дни компании, берем последний из них (вчерашний или раньше)
      - если перед текущим днем недели нет рабочих дней, берем последний рабочий день компании на неделе (т.е. последний день прошлой недели)
      - * период отчета всегда один день
      - * !!! скорее всего БАГ: должно браться макс.число в массиве, а берется последнее. Но дни недели в массиве перемешаны.
    - если предыдущий отчет отсылался
      - вычисляется дата начала отчета, сначала gp->override_report_sent_at, если есть. Потом tbr->last_report_sent_at,
      - глубина ограничивается 2мя неделями
      - формируется массив дат с даты начала по вчерашний день:
        - дата должна входить в рабочие дни недели компании
        - если дата праздничная, то должна быть галка include_holidays
  - по каждой дате выполняется запрос к гугл таблице и отправляется пул сообщений в соотв.чат
  - сохраняются данные об отправке отчета
